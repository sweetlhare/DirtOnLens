# Проект по обнаружению капель воды на изображениях

## Обзор
Проект реализует и сравнивает различные подходы глубокого обучения для обнаружения и сегментации капель воды на изображениях. Основная цель - точное определение и сегментация капель воды на различных поверхностях, что критически важно для компьютерного зрения в неблагоприятных погодных условиях.

## Реализованные подходы

### 1. Архитектура TinyUNet
- Облегченная реализация архитектуры UNet
- Разработана для эффективного вывода при сохранении приемлемой точности
- Достигнутый результат: 0.50796

### 2. YOLOv8 Segmentation
- Использована YOLOv8 с сегментационной головой
- Размер изображения: 384x384
- Лучшая модель с результатом: 0.77373
- Преимущества от сильных возможностей извлечения признаков YOLO

### 3. MobileOne-UNet
- Архитектура UNet с основой MobileOne
- Эффективная архитектура для мобильных устройств
- Достигнутый результат: 0.75372
- Хороший баланс между производительностью и вычислительной эффективностью

## Структура проекта
```
├── synthetic-data-generation.ipynb   # Генерация и аугментация данных
├── unet_model_training.ipynb        # Обучение TinyUNet и MobileOne-UNet
├── yolo_model_training.ipynb        # Обучение модели YOLOv8
├── infer_by_test.py                # Скрипты вывода для обоих подходов
└── image_sorter.py                 # Инструмент сортировки изображений
```

## Инструмент сортировки изображений

Реализован графический интерфейс для удобной сортировки и маркировки изображений:

### Функциональность
- Просмотр изображений и соответствующих масок
- Горячие клавиши для быстрой сортировки:
  - F - сохранение фото и маски в raindrop_image
  - J - сохранение фото (без маски) в empty_image
  - B - пропуск текущего фото
- Автоматическое определение изображений с масками и без
- Прогресс-бар для отслеживания процесса сортировки
- Статистика по обработанным изображениям

### Использование
```bash
python image_sorter.py
```

## Обработка данных

### Генерация синтетических данных
- Реализован синтез капель для аугментации данных
- Генерация вариаций с различными параметрами:
  - Размеры капель (MIN_RADIUS: 3-35, MAX_RADIUS: 40-120)
  - Коэффициенты плотности (0.2-0.7)
  - Уровни прозрачности (ALPHA: 0.1-0.9)
  - Паттерны распределения
- Использованы изображения как с существующими масками капель, так и чистые

### Аугментация данных
- Случайное изменение размера и обрезка
- Горизонтальные и вертикальные отражения
- Поворот и масштабирование
- Эластичные преобразования
- Настройка яркости и контрастности

## Детали обучения

### Общие настройки
- Размер изображения: 256x256
- Размер батча: 32-128
- Скорость обучения: 1e-3 с косинусным затуханием
- Эпохи обучения: 300

### Специфические настройки моделей

#### TinyUNet
- Пользовательская реализация с блоками CMRF
- Функция потерь BCEJaccard
- Ограничение градиента на уровне 1.0

#### YOLOv8
- Предобученная основа
- Стандартная сегментационная голова YOLO
- Нативная функция потерь YOLO

#### MobileOne-UNet
- Предобученный энкодер MobileOne
- Веса Imagenet
- Функция потерь BCEJaccard

## Результаты

| Модель         | IoU Score | Примечания                               |
|---------------|-----------|------------------------------------------|
| TinyUNet      | 0.50796   | Легковесная, но низкая точность         |
| YOLOv8        | 0.77373   | Лучшая производительность, выше требования к вычислениям |
| MobileOne-UNet| 0.75372   | Хороший баланс эффективности и точности  |

## Вывод (Inference)

Реализованы два способа вывода:
1. ONNX-based вывод (segmentation_model.onnx)
2. Нативный PyTorch вывод (предоставляются веса модели)

Пример использования:
```bash
python infer_by_test.py /путь/к/тестовому/датасету /путь/к/выходному.json
```

## Экспорт модели
- Модели могут быть экспортированы в формат ONNX для развертывания
- Поддерживаемые размеры входных данных: 256x256 или 384x384
- Поддержка как CPU, так и CUDA

## Требования
- PyTorch
- Ultralytics (YOLOv8)
- OpenCV
- Albumentations
- ONNX Runtime
- NumPy
- Matplotlib
- PyQt5 (для инструмента сортировки)

## Направления улучшений
- Ансамблевый подход, объединяющий несколько моделей
- Оптимизация для работы в реальном времени
- Более сложная генерация синтетических данных
- Интеграция механизмов внимания
- Тестирование с различными базовыми архитектурами

## Лицензия
Проект распространяется под лицензией MIT.
